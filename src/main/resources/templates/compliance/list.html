<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::div})}">

<head>
    <title>규정 준수 룰팩 관리</title>
</head>

<body>
    <div>
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">내부 규정 준수 룰팩 관리</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <a href="/compliance/compare" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left-right"></i> 버전 비교
                    </a>
                </div>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal"
                    data-bs-target="#uploadModal">
                    <i class="bi bi-upload"></i> 룰팩 업로드
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>버전</th>
                                <th>이름</th>
                                <th>언어</th>
                                <th>Pack ID</th>
                                <th>업로드 일시</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="pack : ${packs}">
                                <td>
                                    <a th:href="@{'/compliance/viewer/' + ${pack.id}}" th:text="${pack.version}"
                                        class="fw-bold text-decoration-none"></a>
                                </td>
                                <td th:text="${pack.name}"></td>
                                <td><span class="badge bg-secondary" th:text="${pack.locale}"></span></td>
                                <td th:text="${pack.packId}" class="text-muted small"></td>
                                <td th:text="${#temporals.format(pack.uploadDate, 'yyyy-MM-dd HH:mm')}"></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger"
                                        th:onclick="'deletePack(' + ${pack.id} + ')'" title="삭제">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(packs)}">
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox display-4 d-block mb-3"></i>
                                    업로드된 룰팩이 없습니다.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div class="modal fade" id="uploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">룰팩 업로드</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="rulepackFile" class="form-label">XML 파일 선택</label>
                                <input class="form-control" type="file" id="rulepackFile" required accept=".xml">
                                <div class="form-text">Fortify 'externalmetadata' XML 파일을 업로드하세요.</div>
                            </div>
                        </form>
                        <div id="uploadProgress" class="progress d-none mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                style="width: 100%"></div>
                        </div>
                        <div id="uploadError" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        <button type="button" class="btn btn-primary" onclick="uploadPack()">업로드</button>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            function uploadPack() {
                const fileInput = document.getElementById('rulepackFile');
                if (!fileInput.files[0]) {
                    alert('파일을 선택해주세요.');
                    return;
                }

                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const progressBar = document.getElementById('uploadProgress');
                const errorAlert = document.getElementById('uploadError');
                const uploadBtn = document.querySelector('#uploadModal .btn-primary');

                progressBar.classList.remove('d-none');
                errorAlert.classList.add('d-none');
                uploadBtn.disabled = true;

                // CSRF Token
                const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                fetch('/api/rulepacks/upload', {
                    method: 'POST',
                    headers: {
                        [csrfHeader]: csrfToken
                    },
                    body: formData
                })
                    .then(async response => {
                        if (!response.ok) {
                            const text = await response.text();
                            throw new Error(text || '업로드 실패');
                        }
                        location.reload();
                    })
                    .catch(error => {
                        errorAlert.textContent = error.message;
                        errorAlert.classList.remove('d-none');
                        progressBar.classList.add('d-none');
                        uploadBtn.disabled = false;
                    });
            }

            function deletePack(id) {
                if (!confirm('정말 이 룰팩을 삭제하시겠습니까?')) return;

                const csrfToken = document.querySelector("meta[name='_csrf']").getAttribute("content");
                const csrfHeader = document.querySelector("meta[name='_csrf_header']").getAttribute("content");

                fetch('/api/rulepacks/' + id, {
                    method: 'DELETE',
                    headers: {
                        [csrfHeader]: csrfToken
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            location.reload();
                        } else {
                            alert('삭제에 실패했습니다.');
                        }
                    });
            }
        </script>
    </div>
</body>

</html>