<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::div})}">

<head>
    <title>룰팩 상세 정보</title>
    <style>
        .group-name {
            font-size: 1.1em;
        }

        .search-item:hover {
            background-color: #f8f9fa;
        }

        .accordion-button:not(.collapsed) {
            background-color: #e7f1ff;
            color: #0c63e4;
        }
    </style>
</head>

<body>
    <div>
        <!-- Header Section -->
        <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <div>
                <h1 class="h2">
                    <span th:text="${pack.name}"></span>
                    <span class="badge bg-secondary fs-6 align-middle" th:text="${pack.version}"></span>
                </h1>
                <p class="text-muted mb-0"
                    th:text="'업로드 일시: ' + ${#temporals.format(pack.uploadDate, 'yyyy-MM-dd HH:mm')}"></p>
            </div>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <a th:href="@{'/api/compliance/export/' + ${pack.id} + '?type=csv'}"
                        class="btn btn-sm btn-outline-success">
                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV 다운로드
                    </a>
                    <a th:href="@{'/api/compliance/export/' + ${pack.id} + '?type=xml'}"
                        class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-file-earmark-code"></i> XML 다운로드
                    </a>
                </div>
                <a href="/compliance" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> 목록으로
                </a>
            </div>
        </div>

        <!-- Controls Toolbar -->
        <div class="row mb-4 align-items-center g-2">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="표준명 검색...">
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div th:if="${groupedStandards.empty}" class="text-center py-5">
            <p class="text-muted">표시할 표준 정보가 없습니다.</p>
        </div>

        <!-- Grouped Accordion View -->
        <div class="accordion" id="orgAccordion" th:unless="${groupedStandards.empty}">
            <div class="accordion-item search-group" th:each="entry : ${groupedStandards}">
                <h2 class="accordion-header" th:id="'heading' + ${#strings.replace(entry.key, ' ', '_')}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        th:data-bs-target="'#collapse' + ${#strings.replace(entry.key, ' ', '_')}" aria-expanded="false"
                        th:aria-controls="'collapse' + ${#strings.replace(entry.key, ' ', '_')}">
                        <i class="bi bi-folder2-open me-2 text-warning"></i>
                        <span class="fw-bold me-2 group-name" th:text="${entry.key}"></span>
                        <span class="badge bg-light text-dark border" th:text="${entry.value.size()} + ' Items'"></span>
                    </button>
                </h2>
                <div th:id="'collapse' + ${#strings.replace(entry.key, ' ', '_')}" class="accordion-collapse collapse"
                    th:aria-labelledby="'heading' + ${#strings.replace(entry.key, ' ', '_')}">
                    <div class="accordion-body p-0">
                        <div class="list-group list-group-flush">
                            <a th:each="std : ${entry.value}"
                                th:href="@{/compliance/viewer/{packId}/standard/{stdId}(packId=${pack.id}, stdId=${std.id})}"
                                class="list-group-item list-group-item-action py-3 search-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <h6 class="mb-1 fw-bold text-primary search-target" th:text="${std.name}"></h6>
                                    <i class="bi bi-chevron-right text-muted small"></i>
                                </div>
                                <p class="mb-1 text-muted small text-truncate search-target"
                                    th:text="${std.description}"></p>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            // --- Search Functionality ---
            document.addEventListener('DOMContentLoaded', function () {
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('keyup', function () {
                    const filter = this.value.toLowerCase();
                    const groups = document.querySelectorAll('.search-group');

                    groups.forEach(group => {
                        let groupVisible = false;
                        const items = group.querySelectorAll('.search-item');

                        // Check Group Name Match
                        const groupName = group.querySelector('.group-name').textContent.toLowerCase();
                        if (groupName.includes(filter)) {
                            groupVisible = true;
                            // Update items visibility? If group matches, maybe show all items? 
                            // Or still filter items? Let's show all items if group matches.
                            items.forEach(item => item.style.display = '');
                        } else {
                            // Filter individual items
                            let hasVisibleItem = false;
                            items.forEach(item => {
                                const targets = item.querySelectorAll('.search-target');
                                let match = false;
                                targets.forEach(t => {
                                    if (t.textContent.toLowerCase().includes(filter)) match = true;
                                });

                                if (match) {
                                    item.style.display = '';
                                    hasVisibleItem = true;
                                } else {
                                    item.style.display = 'none';
                                }
                            });
                            groupVisible = hasVisibleItem;
                        }

                        if (groupVisible) {
                            group.style.display = '';
                            if (filter.length > 0) {
                                const collapse = group.querySelector('.accordion-collapse');
                                if (!collapse.classList.contains('show')) {
                                    new bootstrap.Collapse(collapse, { toggle: true });
                                }
                            }
                        } else {
                            group.style.display = 'none';
                        }
                    });
                });
            });
        </script>
    </div>
</body>

</html>