<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::div})}">

<body>
    <div>
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>사용자 관리</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="bi bi-person-plus"></i> 사용자 추가
                </button>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>사용자명</th>
                                    <th>이름</th>
                                    <th>팀</th>
                                    <th>이메일</th>
                                    <th>권한</th>
                                    <th>생성일</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <!-- Users will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Add User Modal -->
            <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" style="max-width: 600px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addUserModalLabel">사용자 추가</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addUserForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">사용자명</label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">비밀번호</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="name" class="form-label">이름</label>
                                    <input type="text" class="form-control" id="name" name="name">
                                </div>
                                <div class="mb-3">
                                    <label for="team" class="form-label">팀</label>
                                    <input type="text" class="form-control" id="team" name="team">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">이메일</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                                <div class="mb-3">
                                    <label for="role" class="form-label">권한</label>
                                    <select class="form-select" id="role" name="role">
                                        <option value="USER">USER</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                            <button type="button" class="btn btn-primary" id="saveUserBtn">저장</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit User Modal -->
            <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" style="max-width: 600px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editUserModalLabel">사용자 수정</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editUserId">
                            <div class="mb-3">
                                <label for="editName" class="form-label">이름</label>
                                <input type="text" class="form-control" id="editName">
                            </div>
                            <div class="mb-3">
                                <label for="editTeam" class="form-label">팀</label>
                                <input type="text" class="form-control" id="editTeam">
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">이메일</label>
                                <input type="email" class="form-control" id="editEmail">
                            </div>
                            <div class="mb-3">
                                <label for="editRole" class="form-label">권한</label>
                                <select class="form-select" id="editRole">
                                    <option value="USER">USER</option>
                                    <option value="ADMIN">ADMIN</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                            <button type="button" class="btn btn-primary" id="updateUserBtn">수정</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Log Area -->
        <div class="container mt-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Debug Log (실시간 로그)</h5>
                </div>
                <div class="card-body bg-dark text-white"
                    style="height: 200px; overflow-y: auto; font-family: monospace;" id="debugLogArea">
                    <!-- Logs will appear here -->
                </div>
            </div>
        </div>

        <script>
            function logToScreen(message, type = 'INFO') {
                const logArea = document.getElementById('debugLogArea');
                if (!logArea) {
                    console.error("Log area not found!");
                    return;
                }
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'ERROR' ? 'text-danger' : 'text-success';
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> <span class="${color}">[${type}]</span> ${message}`;
                logArea.appendChild(logEntry);
                logArea.scrollTop = logArea.scrollHeight;
                console.log(`[${type}] ${message}`);
            }

            // Immediate log to verify script execution
            console.log("Script loaded immediately");

            document.addEventListener('DOMContentLoaded', function () {
                logToScreen('Page Loaded. Initializing...');
                loadUsers();

                // CSRF Token Helper
                function getCsrfToken() {
                    const tokenMeta = document.querySelector("meta[name='_csrf']");
                    const headerMeta = document.querySelector("meta[name='_csrf_header']");
                    if (!tokenMeta || !headerMeta) {
                        logToScreen('CSRF Meta tags missing!', 'ERROR');
                        return null;
                    }
                    return {
                        token: tokenMeta.getAttribute("content"),
                        header: headerMeta.getAttribute("content")
                    };
                }

                // Load Users
                function loadUsers() {
                    logToScreen('Loading users...');
                    fetch('/api/users')
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to load users: ' + response.status);
                            return response.json();
                        })
                        .then(users => {
                            logToScreen(`Loaded ${users.length} users.`);
                            const tbody = document.getElementById('userTableBody');
                            tbody.innerHTML = '';
                            if (users.length === 0) {
                                tbody.innerHTML = '<tr><td colspan="8" class="text-center">사용자가 없습니다.</td></tr>';
                                return;
                            }
                            users.forEach(user => {
                                const tr = document.createElement('tr');
                                const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleString() : '-';
                                const roleBadge = user.role === 'ADMIN' ? 'bg-danger' : 'bg-secondary';
                                tr.innerHTML = `
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.name || '-'}</td>
                                <td>${user.team || '-'}</td>
                                <td>${user.email || '-'}</td>
                                <td><span class="badge ${roleBadge}">${user.role}</span></td>
                                <td>${createdDate}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal(${user.id}, '${user.role}', '${user.name || ''}', '${user.team || ''}', '${user.email || ''}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            `;
                                tbody.appendChild(tr);
                            });
                        })
                        .catch(error => logToScreen('Error loading users: ' + error, 'ERROR'));
                }

                // Save User
                const saveBtn = document.getElementById('saveUserBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', function () {
                        logToScreen('Save button clicked.');
                        const form = document.getElementById('addUserForm');
                        if (!form.checkValidity()) {
                            logToScreen('Form validation failed.', 'ERROR');
                            form.reportValidity();
                            return;
                        }

                        const csrf = getCsrfToken();
                        if (!csrf) {
                            alert('보안 토큰 오류: 페이지를 새로고침하세요.');
                            return;
                        }

                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());

                        logToScreen(`Attempting to create user: ${data.username}`);

                        fetch('/api/users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                [csrf.header]: csrf.token
                            },
                            body: JSON.stringify(data)
                        })
                            .then(async response => {
                                logToScreen(`Server response status: ${response.status}`);
                                if (response.ok) {
                                    logToScreen('User created successfully.');
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                                    modal.hide();
                                    form.reset();
                                    loadUsers();
                                    alert('사용자가 성공적으로 추가되었습니다.');
                                } else {
                                    const errorText = await response.text();
                                    logToScreen(`Create user failed: ${errorText}`, 'ERROR');
                                    alert('사용자 추가 실패: ' + errorText);
                                }
                            })
                            .catch(error => {
                                logToScreen(`Network error: ${error}`, 'ERROR');
                                alert('네트워크 오류가 발생했습니다.');
                            });
                    });
                } else {
                    logToScreen('Save button not found in DOM!', 'ERROR');
                }

                // Update User
                const updateBtn = document.getElementById('updateUserBtn');
                if (updateBtn) {
                    updateBtn.addEventListener('click', function () {
                        const id = document.getElementById('editUserId').value;
                        const name = document.getElementById('editName').value;
                        const team = document.getElementById('editTeam').value;
                        const email = document.getElementById('editEmail').value;
                        const role = document.getElementById('editRole').value;
                        const csrf = getCsrfToken();

                        if (!csrf) return;

                        logToScreen(`Updating user ${id}...`);

                        const data = {
                            name: name,
                            team: team,
                            email: email,
                            role: role
                        };

                        fetch(`/api/users/${id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                [csrf.header]: csrf.token
                            },
                            body: JSON.stringify(data)
                        })
                            .then(response => {
                                if (response.ok) {
                                    logToScreen('User updated successfully.');
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                                    modal.hide();
                                    loadUsers();
                                    alert('사용자 정보가 수정되었습니다.');
                                } else {
                                    logToScreen('User update failed.', 'ERROR');
                                    alert('사용자 수정 실패');
                                }
                            })
                            .catch(error => logToScreen('Error updating user: ' + error, 'ERROR'));
                    });
                }

                // Global functions for onclick handlers
                window.deleteUser = function (id) {
                    if (!confirm('정말 이 사용자를 삭제하시겠습니까?')) return;

                    const csrf = getCsrfToken();
                    if (!csrf) return;

                    logToScreen(`Deleting user ${id}...`);

                    fetch(`/api/users/${id}`, {
                        method: 'DELETE',
                        headers: {
                            [csrf.header]: csrf.token
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                logToScreen('User deleted successfully.');
                                loadUsers();
                            } else {
                                logToScreen('Delete failed.', 'ERROR');
                                alert('삭제 실패');
                            }
                        })
                        .catch(error => logToScreen('Error deleting user: ' + error, 'ERROR'));
                };

                window.openEditModal = function (id, role, name, team, email) {
                    document.getElementById('editUserId').value = id;
                    document.getElementById('editRole').value = role;
                    document.getElementById('editName').value = name;
                    document.getElementById('editTeam').value = team;
                    document.getElementById('editEmail').value = email;
                    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                    modal.show();
                };
            });
        </script>
    </div>
</body>

</html>